<!-- <!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RequestApp - Real-time Messaging</title>
    <link rel="stylesheet" href="/assets/tailwind.css" />
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <style> -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RequestApp - Real-time Messaging</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <style>
      /* Custom utility classes based on minimalist palette */
      .bg-surface {
        background-color: #f5f5f5; /* Surface: #F5F5F5 */
      }
      .bg-hover {
        background-color: #fafafa; /* Hover: #FAFAFA */
      }
      .text-secondary {
        color: #6b6b6b; /* Text Secondary: #6B6B6B */
      }
      .border-light {
        border-color: #e5e5e5; /* Border: #E5E5E5 */
      }
      .divide-divider {
        border-color: #f0f0f0; /* Divider: #F0F0F0 */
      }
      .bg-primary {
        background-color: #2d7ff9; /* Primary Accent: #2D7FF9 */
      }
      .bg-primary-hover:hover {
        background-color: #1a6ae8; /* Slightly darker shade of accent blue */
      }
      .text-primary {
        color: #1a1a1a; /* Text Primary: #1A1A1A */
      }
      .bg-received {
        background-color: #f5f5f5; /* Received Message: #F5F5F5 */
      }

      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      /* Consistent Shadow for Message Bubbles */
      .shadow-message {
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      }
    </style>
  </head>
  <body class="bg-white h-screen overflow-hidden">
    <div class="flex h-screen">
      <div
        class="w-[25rem] bg-white border-r border-light flex flex-col h-full rounded-none"
      >
        <div class="p-4 border-b border-light bg-surface">
          <div class="flex items-center justify-between">
            <h2 class="text-3xl font-bold text-primary">RequestApp</h2>

            <div class="flex space-x-2">
              <button
                class="p-2 rounded-full text-primary hover:bg-hover transition transform hover:scale-110"
                title="Toggle Dark Mode"
              >
                <svg
                  class="w-6 h-6"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
                  ></path>
                </svg>
              </button>

              <button
                onclick="openNewGroupModal()"
                class="p-2 rounded-full text-primary hover:bg-hover transition transform hover:scale-110"
                title="New Group"
              >
                <svg
                  class="w-6 h-6"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17 20h-5v-1a4 4 0 00-4-4H4a4 4 0 00-4 4v1h12m7-2h-3v-3a2 2 0 00-2-2H8a2 2 0 00-2 2v3h-3a1 1 0 01-1-1V7a1 1 0 011-1h18a1 1 0 011 1v12a1 1 0 01-1 1zm-8-3a4 4 0 11-8 0 4 4 0 018 0z"
                  ></path>
                </svg>
              </button>

              <button
                onclick="openNewChatModal()"
                class="p-2 rounded-full text-primary hover:bg-hover transition transform hover:scale-110"
                title="New Chat"
              >
                <svg
                  class="w-6 h-6"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"
                  ></path>
                </svg>
              </button>
            </div>
          </div>
        </div>

        <div class="p-3 border-b border-light">
          <input
            type="text"
            id="chatSearchInput"
            placeholder="Search or start new chat..."
            class="w-full px-4 py-2 border border-light bg-white text-primary rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition placeholder-gray-400 shadow-sm"
          />
        </div>

        <div class="flex-1 overflow-y-auto scrollbar-hide">
          <div id="roomsList" class="divide-y divide-divider"></div>
        </div>

        <div class="p-4 border-t border-light bg-surface">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
              <img
                id="currentUserAvatar"
                src=""
                alt="Avatar"
                class="w-10 h-10 rounded-full border-2 border-blue-500"
              />
              <div>
                <h2
                  id="currentUserName"
                  class="font-semibold text-primary"
                ></h2>
                <p class="text-xs text-secondary">My Profile</p>
              </div>
            </div>
            <button
              onclick="logout()"
              class="text-secondary hover:text-red-500 transition p-2 rounded-full hover:bg-hover transform hover:scale-110"
              title="Logout"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                ></path>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div class="flex-1 flex flex-col">
        <div
          id="chatHeader"
          class="hidden bg-surface border-b border-light p-4 shadow-sm"
        >
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
              <img
                id="chatAvatar"
                src=""
                alt="Avatar"
                class="w-12 h-12 rounded-full"
              />
              <div>
                <h3 id="chatName" class="font-semibold text-primary"></h3>
                <div class="flex items-center space-x-2">
                  <span
                    id="chatStatus"
                    class="w-2 h-2 rounded-full bg-gray-300"
                  ></span>
                  <p id="chatStatusText" class="text-sm text-secondary"></p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div
          id="welcomeScreen"
          class="flex-1 flex items-center justify-center bg-white"
        >
          <div class="text-center">
            <div class="text-6xl mb-4 text-primary">ðŸ’¬</div>
            <h2 class="text-2xl font-bold text-primary mb-2">
              Welcome to Request App
            </h2>
            <p class="text-secondary">
              Select a chat or start a new conversation
            </p>
          </div>
        </div>

        <div
          id="messagesArea"
          class="hidden flex-1 overflow-y-auto p-4 space-y-4 scrollbar-hide bg-white"
        >
          <div id="messagesList"></div>
        </div>

        <div
          id="typingIndicator"
          class="hidden px-4 py-2 text-sm text-secondary italic bg-surface"
        >
          <span id="typingText"></span>
        </div>

        <div
          id="messageInput"
          class="hidden bg-white border-t border-light p-4 shadow-sm"
        >
          <form id="messageForm" class="flex space-x-3">
            <input
              type="text"
              id="messageContent"
              placeholder="Type a message..."
              class="flex-1 px-4 py-3 border border-light bg-white text-primary rounded-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none placeholder-gray-400"
              autocomplete="off"
            />
            <button
              type="submit"
              class="bg-primary bg-primary-hover text-white px-6 py-3 rounded-full transition transform hover:scale-105 shadow-md"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"
                ></path>
              </svg>
            </button>
          </form>
        </div>
      </div>
    </div>

    <div
      id="newGroupModal"
      class="hidden fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50"
    >
      <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-xl">
        <h3 class="text-2xl font-bold mb-4 text-primary">Create New Group</h3>
        <form id="newGroupForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-secondary mb-2"
              >Group Name</label
            >
            <input
              type="text"
              id="groupName"
              required
              class="w-full px-4 py-2 border border-light bg-white text-primary rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-secondary mb-2"
              >Description</label
            >
            <textarea
              id="groupDescription"
              rows="3"
              class="w-full px-4 py-2 border border-light bg-white text-primary rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
            ></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-secondary mb-2"
              >Add Members</label
            >
            <div
              id="usersList"
              class="max-h-48 overflow-y-auto space-y-2 border border-light rounded-xl p-2 text-secondary"
            ></div>
          </div>
          <div class="flex space-x-3">
            <button
              type="submit"
              class="flex-1 bg-primary bg-primary-hover text-white py-3 rounded-xl transition shadow-md"
            >
              Create
            </button>
            <button
              type="button"
              onclick="closeNewGroupModal()"
              class="flex-1 bg-gray-200 hover:bg-gray-300 text-primary py-3 rounded-xl transition"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <div
      id="newChatModal"
      class="hidden fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50"
    >
      <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-xl">
        <h3 class="text-2xl font-bold mb-4 text-primary">
          Start New Chat (by Username)
        </h3>
        <form id="findUserChatForm" class="space-y-4">
          <div>
            <label
              for="targetUsername"
              class="block text-sm font-medium text-secondary mb-2"
              >Enter Username</label
            >
            <input
              type="text"
              id="targetUsername"
              required
              class="w-full px-4 py-2 border border-light bg-white text-primary rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
              placeholder="e.g., johndoe"
            />
          </div>
          <div
            id="newChatErrorMessage"
            class="hidden bg-red-100 border border-red-300 text-red-600 px-4 py-3 rounded-xl text-sm"
          ></div>
          <div class="flex space-x-3">
            <button
              type="submit"
              class="flex-1 bg-primary bg-primary-hover text-white py-3 rounded-xl transition shadow-md"
            >
              Start Chat
            </button>
            <button
              type="button"
              onclick="closeNewChatModal()"
              class="flex-1 bg-gray-200 hover:bg-gray-300 text-primary py-3 rounded-xl transition"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Global variables
      let socket;
      let currentUser;
      let currentRoom = null;
      let rooms = [];
      let typingTimeout;

      // Initialize
      document.addEventListener("DOMContentLoaded", async () => {
        const token = localStorage.getItem("token");
        const userStr = localStorage.getItem("user");

        if (!token || !userStr) {
          window.location.href = "/login.html";
          return;
        }

        currentUser = JSON.parse(userStr);

        // Set current user info
        document.getElementById("currentUserName").textContent =
          currentUser.username;
        document.getElementById("currentUserAvatar").src = currentUser.avatar;

        // Initialize Socket.IO
        initSocket(token);

        // Load rooms
        await loadRooms();

        // Setup message form
        setupMessageForm();
      });

      // Initialize Socket.IO
      function initSocket(token) {
        socket = io({
          auth: { token },
        });

        socket.on("connect", () => {
          console.log("âœ… Connected to server");
        });

        socket.on("message:new", (message) => {
          if (currentRoom && message.room === currentRoom._id) {
            appendMessage(message);
            scrollToBottom();
          }
          updateRoomLastMessage(message);
        });

        socket.on("user:status", ({ userId, status }) => {
          updateUserStatus(userId, status);
        });

        socket.on("typing:start", ({ userId, username, roomId }) => {
          if (currentRoom && roomId === currentRoom._id) {
            showTyping(username);
          }
        });

        socket.on("typing:stop", ({ roomId }) => {
          if (currentRoom && roomId === currentRoom._id) {
            hideTyping();
          }
        });

        socket.on("error", (error) => {
          console.error("Socket error:", error);
        });
      }

      // Load rooms
      async function loadRooms() {
        try {
          const response = await fetch("/api/chat/rooms", {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });
          const data = await response.json();

          if (data.success) {
            rooms = data.rooms;
            renderRooms();
          }
        } catch (error) {
          console.error("Error loading rooms:", error);
        }
      }

      // Render rooms list
      function renderRooms() {
        const roomsList = document.getElementById("roomsList");
        roomsList.innerHTML = "";

        rooms.forEach((room) => {
          const roomDiv = document.createElement("div");
          // Applying custom hover color
          roomDiv.className = "p-4 hover:bg-hover cursor-pointer transition";
          roomDiv.onclick = () => selectRoom(room);

          const otherParticipant =
            room.type === "private"
              ? room.participants.find((p) => p._id !== currentUser._id)
              : null;

          const displayName =
            room.type === "private" && otherParticipant
              ? otherParticipant.username
              : room.name;

          const displayAvatar =
            room.type === "private" && otherParticipant
              ? otherParticipant.avatar
              : room.avatar;

          const isOnline =
            room.type === "private" && otherParticipant?.status === "online";

          roomDiv.innerHTML = `
          <div class="flex items-center space-x-3">
            <div class="relative">
              <img src="${displayAvatar}" alt="${displayName}" class="w-12 h-12 rounded-full">
              ${
                isOnline
                  ? '<span class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full"></span>'
                  : ""
              }
            </div>
            <div class="flex-1 min-w-0">
              <h4 class="font-semibold text-primary truncate">${displayName}</h4>
              <p class="text-sm text-secondary truncate">${
                room.type === "group"
                  ? `${room.participants.length} members`
                  : ""
              }</p>
            </div>
          </div>
        `;

          roomsList.appendChild(roomDiv);
        });
      }

      // Select room
      async function selectRoom(room) {
        currentRoom = room;

        // Join room
        socket.emit("room:join", room._id);

        // Update UI
        document.getElementById("welcomeScreen").classList.add("hidden");
        document.getElementById("chatHeader").classList.remove("hidden");
        document.getElementById("messagesArea").classList.remove("hidden");
        document.getElementById("messageInput").classList.remove("hidden");

        const otherParticipant =
          room.type === "private"
            ? room.participants.find((p) => p._id !== currentUser._id)
            : null;

        const displayName =
          room.type === "private" && otherParticipant
            ? otherParticipant.username
            : room.name;

        const displayAvatar =
          room.type === "private" && otherParticipant
            ? otherParticipant.avatar
            : room.avatar;

        document.getElementById("chatName").textContent = displayName;
        document.getElementById("chatAvatar").src = displayAvatar;

        // Load messages
        await loadMessages(room._id);
      }

      // Load messages
      async function loadMessages(roomId) {
        try {
          const response = await fetch(`/api/chat/rooms/${roomId}/messages`, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });
          const data = await response.json();

          if (data.success) {
            const messagesList = document.getElementById("messagesList");
            messagesList.innerHTML = "";
            data.messages.forEach((message) => appendMessage(message));
            scrollToBottom();
          }
        } catch (error) {
          console.error("Error loading messages:", error);
        }
      }

      // Append message to UI
      function appendMessage(message) {
        const messagesList = document.getElementById("messagesList");
        const isOwn = message.sender._id === currentUser._id;

        const messageDiv = document.createElement("div");
        messageDiv.className = `flex ${
          isOwn ? "justify-end" : "justify-start"
        }`;

        const time = new Date(message.createdAt).toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });

        messageDiv.innerHTML = `
        <div class="flex ${
          isOwn ? "flex-row-reverse" : "flex-row"
        } items-end space-x-2 max-w-md">
          ${
            !isOwn
              ? `<img src="${message.sender.avatar}" alt="${message.sender.username}" class="w-8 h-8 rounded-full">`
              : ""
          }
          <div>
            ${
              !isOwn
                ? `<p class="text-xs text-secondary mb-1 px-2">${message.sender.username}</p>`
                : ""
            }
            <div class="${
              isOwn ? "bg-primary text-white" : "bg-received text-primary"
            } rounded-2xl px-4 py-2 shadow-message">
              <p class="break-words">${escapeHtml(message.content)}</p>
              <p class="text-xs ${
                isOwn ? "text-blue-100" : "text-secondary"
              } mt-1">${time}</p>
            </div>
          </div>
        </div>
      `;

        messagesList.appendChild(messageDiv);
      }

      // Setup message form
      function setupMessageForm() {
        const form = document.getElementById("messageForm");
        const input = document.getElementById("messageContent");

        form.addEventListener("submit", (e) => {
          e.preventDefault();
          const content = input.value.trim();

          if (content && currentRoom) {
            socket.emit("message:send", {
              roomId: currentRoom._id,
              content,
            });
            input.value = "";
            socket.emit("typing:stop", { roomId: currentRoom._id });
          }
        });

        // Typing indicator
        input.addEventListener("input", () => {
          if (currentRoom) {
            socket.emit("typing:start", { roomId: currentRoom._id });

            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
              socket.emit("typing:stop", { roomId: currentRoom._id });
            }, 1000);
          }
        });
      }

      // Typing indicators
      function showTyping(username) {
        const indicator = document.getElementById("typingIndicator");
        const text = document.getElementById("typingText");
        text.textContent = `${username} is typing...`;
        indicator.classList.remove("hidden");
      }

      function hideTyping() {
        document.getElementById("typingIndicator").classList.add("hidden");
      }

      // New Group Modal
      function openNewGroupModal() {
        const modal = document.getElementById("newGroupModal");
        const usersList = document.getElementById("usersList");

        usersList.innerHTML =
          '<p class="text-sm text-secondary italic">User selection for groups is currently unavailable in this version. You will be the sole participant upon creation.</p>';

        modal.classList.remove("hidden");
      }

      function closeNewGroupModal() {
        document.getElementById("newGroupModal").classList.add("hidden");
        document.getElementById("newGroupForm").reset();
      }

      document
        .getElementById("newGroupForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const name = document.getElementById("groupName").value;
          const description = document.getElementById("groupDescription").value;
          const checkboxes = document.querySelectorAll(
            ".user-checkbox:checked"
          );
          const participants = Array.from(checkboxes).map((cb) => cb.value);

          try {
            const response = await fetch("/api/chat/rooms", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
              body: JSON.stringify({
                name,
                description,
                type: "group",
                participants,
              }),
            });

            const data = await response.json();
            if (data.success) {
              closeNewGroupModal();
              await loadRooms();
            }
          } catch (error) {
            console.error("Error creating group:", error);
          }
        });

      // New Chat Modal
      function openNewChatModal() {
        const modal = document.getElementById("newChatModal");
        document.getElementById("newChatErrorMessage").classList.add("hidden");
        document.getElementById("targetUsername").value = "";
        modal.classList.remove("hidden");
      }

      function closeNewChatModal() {
        document.getElementById("newChatModal").classList.add("hidden");
      }

      document
        .getElementById("findUserChatForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const targetUsername = document
            .getElementById("targetUsername")
            .value.trim();
          const errorMessageDiv = document.getElementById(
            "newChatErrorMessage"
          );
          errorMessageDiv.classList.add("hidden");

          if (!targetUsername) return;

          try {
            const response = await fetch(
              "/api/chat/rooms/private-by-username",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${localStorage.getItem("token")}`,
                },
                body: JSON.stringify({ targetUsername }),
              }
            );

            const data = await response.json();

            if (data.success) {
              closeNewChatModal();

              const existingRoom = rooms.find((r) => r._id === data.room._id);
              if (!existingRoom) {
                rooms.unshift(data.room);
                renderRooms();
              }

              selectRoom(data.room);
            } else {
              errorMessageDiv.textContent =
                data.message || "User not found or an error occurred.";
              errorMessageDiv.classList.remove("hidden");
            }
          } catch (error) {
            console.error("Error creating private chat by username:", error);
            errorMessageDiv.textContent =
              "An unexpected network error occurred.";
            errorMessageDiv.classList.remove("hidden");
          }
        });

      // Utility functions
      function scrollToBottom() {
        const messagesArea = document.getElementById("messagesArea");
        messagesArea.scrollTop = messagesArea.scrollHeight;
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function updateUserStatus(userId, status) {
        renderRooms();
      }

      function updateRoomLastMessage(message) {
        const room = rooms.find((r) => r._id === message.room);
        if (room) {
          room.lastMessage = message;
          renderRooms();
        }
      }

      function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        socket.disconnect();
        window.location.href = "/login.html";
      }
    </script>
  </body>
</html>
